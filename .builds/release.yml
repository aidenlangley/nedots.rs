image: alpine/latest
packages:
  - rustup
triggers:
  - action: email
    condition: failure
    to: Aiden Langley <aiden@nedia.dev>
secrets:
  - f049bb15-5272-485e-b7ca-67b90598d980
environment:
  known_hosts: |
    git.sr.ht ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMZvRd4EtM7R+IHVMWmDkVU3VLQTSwQDSAvW0t2Tkj60
    git.sr.ht ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBCj6y+cJlqK3BHZRLZuM+KP2zGPrh4H66DacfliU1E2DHAd1GGwF4g1jwu3L8gOZUTIvUptqWTkmglpYhFp4Iy4=
  remote: git@git.sr.ht:~nedia/nedots
  release: ./nedots.rs/target/release/nedots
tasks:
  - rustup: |
      rustup-init -y
      echo "source $HOME/.cargo/env" >> .buildenv
  - setup: |
      rustup toolchain install stable
      cd nedots.rs
      rustup run stable cargo fetch
  - build_release: |
      cd nedots.rs
      rustup default stable
      cargo build --release
  - init: |
      echo $known_hosts >> .ssh/known_hosts
      $release init --from-user aiden $remote
  - install: |
      $release install nedots
  - backup: |
      $release backup
  - clean: |
      $release clean --dots --backups --assumeyes
  - sync: |
      $release sync --gather --nopush
